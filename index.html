<?php
session_start();

$pdo = new PDO("mysql:host=localhost;dbname=openenglish;charset=utf8", "root", "");
$msg = "";

if (isset($_POST["accion"]) && $_POST["accion"] == "registro") {
    $stmt = $pdo->prepare("INSERT INTO estudiantes(nombre,apellido,email) VALUES (?,?,?)");
    $stmt->execute([$_POST["nombre"], $_POST["apellido"], $_POST["email"]]);
    $id = $pdo->lastInsertId();

    $stmt = $pdo->prepare("INSERT INTO usuarios(username,password_hash,email,rol_id,estudiante_id)
    VALUES (?,?,?,?,?)");
    $stmt->execute([
        $_POST["username"],
        $_POST["password"],
        $_POST["email"],
        3,
        $id
    ]);

    $msg = "Usuario registrado";
}

if (isset($_POST["accion"]) && $_POST["accion"] == "login") {
    $stmt = $pdo->prepare("SELECT * FROM usuarios WHERE username=? AND password_hash=?");
    $stmt->execute([$_POST["username"], $_POST["password"]]);
    $u = $stmt->fetch();

    if ($u) {
        $_SESSION["user"] = $u;
    } else {
        $msg = "Login incorrecto";
    }
}

if (isset($_POST["accion"]) && $_POST["accion"] == "logout") {
    session_destroy();
    header("Location: index.php");
}

if (isset($_POST["accion"]) && $_POST["accion"] == "inscribir") {
    $pdo->prepare("INSERT INTO matricula(estudiante_id,curso_id)
    VALUES (?,?)")->execute([$_SESSION["user"]["estudiante_id"], $_POST["curso_id"]]);
    $msg = "Inscrito correctamente";
}

$cursos = $pdo->query("SELECT * FROM v_cursos_publicos")->fetchAll();

$mis = [];
if (isset($_SESSION["user"]) && $_SESSION["user"]["rol_id"] == 3) {
    $stmt = $pdo->prepare("SELECT * FROM v_historial_cliente WHERE usuario_id=?");
    $stmt->execute([$_SESSION["user"]["usuario_id"]]);
    $mis = $stmt->fetchAll();
}
?>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>OpenEnglish</title>
<script src="script.js"></script>
</head>
<body>

<h2>Login</h2>
<form method="post">
<input type="hidden" name="accion" value="login">
<input name="username" placeholder="Usuario">
<input name="password" placeholder="Clave">
<button>Entrar</button>
</form>

<h2>Registro Estudiante</h2>
<form method="post">
<input type="hidden" name="accion" value="registro">
<input name="nombre" placeholder="Nombre">
<input name="apellido" placeholder="Apellido">
<input name="email" placeholder="Email">
<input name="username" placeholder="Usuario">
<input name="password" placeholder="Clave">
<button>Registrar</button>
</form>

<?php if(isset($_SESSION["user"])): ?>

<form method="post">
<input type="hidden" name="accion" value="logout">
<button>Salir</button>
</form>

<h2>Cursos</h2>
<?php foreach($cursos as $c): ?>
<form method="post">
<?= $c["titulo"] ?> - <?= $c["profesor"] ?>
<input type="hidden" name="curso_id" value="<?= $c["curso_id"] ?>">
<input type="hidden" name="accion" value="inscribir">
<button>Inscribirse</button>
</form>
<?php endforeach; ?>

<h2>Mis Cursos</h2>
<?php foreach($mis as $m): ?>
<p><?= $m["curso"] ?> - <?= $m["fecha_matricula"] ?> - <?= $m["monto"] ?></p>
<?php endforeach; ?>

<?php endif; ?>

<p><?= $msg ?></p>

</body>
</html>
