DROP DATABASE IF EXISTS openenglish;
CREATE DATABASE openenglish;
USE openenglish;

CREATE TABLE profesores (
  profesor_id INT AUTO_INCREMENT PRIMARY KEY,
  nombre VARCHAR(100) NOT NULL,
  apellido VARCHAR(100) NOT NULL,
  email VARCHAR(150) NOT NULL UNIQUE
);

CREATE TABLE curso (
  curso_id INT AUTO_INCREMENT PRIMARY KEY,
  titulo VARCHAR(150) NOT NULL,
  descripcion TEXT,
  profesor_id INT NOT NULL,
  FOREIGN KEY (profesor_id) REFERENCES profesores(profesor_id)
);

CREATE TABLE estudiantes (
  estudiante_id INT AUTO_INCREMENT PRIMARY KEY,
  nombre VARCHAR(100) NOT NULL,
  apellido VARCHAR(100) NOT NULL,
  email VARCHAR(150) NOT NULL UNIQUE
);

CREATE TABLE metodos_pago (
  metodo_pago_id INT AUTO_INCREMENT PRIMARY KEY,
  nombre VARCHAR(50) NOT NULL UNIQUE
);

CREATE TABLE matricula (
  matricula_id INT AUTO_INCREMENT PRIMARY KEY,
  estudiante_id INT NOT NULL,
  curso_id INT NOT NULL,
  fecha_matricula DATETIME DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (estudiante_id) REFERENCES estudiantes(estudiante_id),
  FOREIGN KEY (curso_id) REFERENCES curso(curso_id),
  UNIQUE (estudiante_id, curso_id)
);

CREATE TABLE pagos (
  pago_id INT AUTO_INCREMENT PRIMARY KEY,
  matricula_id INT NOT NULL UNIQUE,
  monto DECIMAL(10,2) NOT NULL,
  fecha_pago DATETIME DEFAULT CURRENT_TIMESTAMP,
  metodo_pago_id INT NOT NULL,
  FOREIGN KEY (matricula_id) REFERENCES matricula(matricula_id),
  FOREIGN KEY (metodo_pago_id) REFERENCES metodos_pago(metodo_pago_id)
);

CREATE TABLE roles_app (
  rol_id INT AUTO_INCREMENT PRIMARY KEY,
  nombre VARCHAR(50) NOT NULL UNIQUE
);

CREATE TABLE usuarios (
  usuario_id INT AUTO_INCREMENT PRIMARY KEY,
  username VARCHAR(50) NOT NULL UNIQUE,
  password_hash VARCHAR(255) NOT NULL,
  email VARCHAR(150) NOT NULL UNIQUE,
  rol_id INT NOT NULL,
  estudiante_id INT,
  creado_en DATETIME DEFAULT CURRENT_TIMESTAMP,
  activo TINYINT(1) DEFAULT 1,
  FOREIGN KEY (rol_id) REFERENCES roles_app(rol_id),
  FOREIGN KEY (estudiante_id) REFERENCES estudiantes(estudiante_id)
);

INSERT INTO profesores (nombre, apellido, email)
VALUES ('Andres', 'Ramirez', 'andresr@gmail.com');

INSERT INTO curso (titulo, descripcion, profesor_id) VALUES
('Inglés Básico A1', 'Curso para empezar desde cero', 1),
('Inglés Conversacional', 'Práctica de hablar y escuchar', 1);

INSERT INTO metodos_pago (nombre) VALUES
('Pago Móvil'),
('Cashea'),
('Transferencia');

INSERT INTO roles_app (nombre) VALUES
('ADMIN'),
('PROFESOR'),
('ESTUDIANTE');

INSERT INTO usuarios (username, password_hash, email, rol_id, estudiante_id)
VALUES (
  'admin',
  'admin123',
  'admin@gmail.com',
  (SELECT rol_id FROM roles_app WHERE nombre = 'ADMIN'),
  NULL
);

INSERT INTO usuarios (username, password_hash, email, rol_id, estudiante_id)
VALUES (
  'andres',
  'andres123',
  'andresr@gmail.com',
  (SELECT rol_id FROM roles_app WHERE nombre = 'PROFESOR'),
  NULL
);

CREATE VIEW v_cursos_publicos AS
SELECT c.curso_id,c.titulo,c.descripcion,
CONCAT(p.nombre,' ',p.apellido) AS profesor
FROM curso c
JOIN profesores p ON p.profesor_id=c.profesor_id;

CREATE VIEW v_historial_cliente AS
SELECT u.usuario_id,c.titulo AS curso,
m.fecha_matricula,p.monto,p.fecha_pago
FROM usuarios u
JOIN estudiantes e ON u.estudiante_id=e.estudiante_id
JOIN matricula m ON m.estudiante_id=e.estudiante_id
LEFT JOIN pagos p ON p.matricula_id=m.matricula_id
JOIN curso c ON c.curso_id=m.curso_id;

